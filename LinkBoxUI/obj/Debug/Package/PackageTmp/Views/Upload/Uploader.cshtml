@model DomainLayer.ViewModels.UploadViewModel
<section class="content">
    <div class="row">
        <div class="col-xs-12">
            <form id="upload-submit">
                <div class="box">
                    <div class="box-header">
                        <h3 class="box-title">Upload</h3>
                    </div>
                    <!-- /.box-header -->
                    <div class="box-body">
                        @*<div class="form-group">
                                <label>Field Mapping Code Or Process Code</label>
                                <div class="input-group">
                                    <div class="input-group-addon">
                                        <i class="fa fa-tasks"></i>
                                    </div>
                                    <input type="text" class="form-control" placeholder="Module" id="field-module">
                                    <select class="form-control select2" style="width: 15%;" id="select-server">
                                        @foreach (var item in Model.SAPList)
                                        {
                                            <option value="@item.Code">@item.Code</option>
                                        }
                                    </select>
                                </div>
                            </div>*@
                        <table id="executeQueryTable" class="table table-bordered table-striped" style="width:100%;">

                            <!--<thead>
                            <tr>
                                <th><input type="checkbox" class="icheckbox_square-blue flat-red" id="checkall" /></th>-->
                            @*@if (Model.AuthList.Count != 0)
                                {
                                    if (Model.AuthList[0].authorization != "" || Model.AuthList[0].authorization != null)
                                    {
                                        <th id="exist">Deposit</th>
                                    }
                                }*@
                            <!--<th>Transaction Id</th>
                                    <th>Terminal No</th>
                                    <th>Transaction Date</th>
                                    <th>Status</th>
                                    <th>Action</th>

                                </tr>
                            </thead>
                            <tbody>
                                <tr>-->
                            @*@foreach ()
                                {



                                }*@
                            <!--<td width="5%"><input type="checkbox" class="flat-red check" /></td>
                                    <td>2</td>
                                    <td>1</td>
                                    <td>3/16/2021</td>
                                    <td><span class="label label-success">Open</span></td>
                                    <td><button type="button" class="btn btn-primary" data-toggle="modal" data-target="#create-modal">View</button></td>
                                </tr>
                            </tbody>-->
                        </table>
                        <div class="form-group">
                            <label>Process Code</label>
                            <div class="input-group">
                                <div class="input-group-addon">
                                    <i class="fa fa-tasks"></i>
                                </div>
                                @*<input type="text" class="form-control" placeholder="Module" id="field-module">*@
                                <select class="form-control select2" style="width: 15%;" id="select-process">
                                    @foreach (var item in Model.ProcessList)
                                    {
                                        <option value="@item.ProcessCode">@item.ProcessName</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <table class="dataTable table table-hover table-bordered table-responsive" id="process-table">
                            <thead>
                                <tr>
                                    <th class="w-15"><input type="checkbox" id="checkall"></th>
                                    <th class="w-15">Map Code </th>
                                    <th class="w-25">Map Name</th>
                                    <th class="w-50">Module</th>
                                    <th class="w-50">Progress</th>
                                </tr>
                            </thead>
                            <tbody>
                                @*@foreach (var item in Model.FieldMappingList)
                                    {
                                        <tr>
                                            <td class="draftkey"><input type="checkbox" class="check" data-value="@item.MapCode"></td>
                                            <td>@item.MapCode</td>
                                            <td>@item.MapName</td>
                                            <td>@item.ModuleName</td>
                                            <td><div id="@item.MapCode-@item.ModuleName-progressbar" class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar" style="width: 10%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div></td>
                                        </tr>
                                    }*@
                            </tbody>
                        </table>
                        <button type="submit" class="btn btn-primary btn-custom2 pull-right" id="uploadbtn">Upload</button>

                        @*<button type="button" class="btn btn-flat btn-secondary btn-custom2" style="float: right;" data-toggle="modal" data-target="#create-modal">Check</button>*@
                    </div>

                    <!-- /.box-body -->
                </div>
            </form>
        </div>
    </div>
</section>

<div class="modal fade" id="create-modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Details</h4>
            </div>
            <div class="modal-body">
                <div class="box-body">
                    <!-- Custom Tabs -->
                    <div class="nav-tabs-custom">
                        <ul class="nav nav-tabs">
                            <li class="active"><a href="#tab_1" data-toggle="tab">Header</a></li>
                            <li><a href="#tab_2" data-toggle="tab">Row</a></li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane active" id="tab_1">
                                <table id="data-table2" class="table table-bordered table-striped">

                                    <thead>
                                        <tr>
                                            <th>Header Id</th>
                                            <th>Map ID</th>
                                            <th>Terminal No</th>
                                            <th>TransDate</th>
                                            <th>Cashier Name</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>1</td>
                                            <td>4</td>
                                            <td>1</td>
                                            <td>3/16/2021</td>
                                            <td>Cashier 74</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- /.tab-pane -->
                            <div class="tab-pane" id="tab_2">
                                <table id="data-table1" class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th>Row Id</th>
                                            <th>Map ID</th>
                                            <th>Terminal No</th>
                                            <th>TransDate</th>
                                            <th>Cashier Name</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>1</td>
                                            <td>4</td>
                                            <td>1</td>
                                            <td>3/16/2021</td>
                                            <td>Cashier 74</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- /.tab-pane -->
                        </div>
                        <!-- /.tab-content -->
                    </div>

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>

@section Scripts {
    <script>
        $(function () {
            $('[data-mask]').inputmask()

            $('#deposit').DataTable({
                'paging': true,
                'lengthChange': true,
                'searching': true,
                'ordering': true,
                'info': true,
                'autoWidth': false
            })
            $('#data-table').DataTable({
                'paging': true,
                'lengthChange': true,
                'searching': true,
                'ordering': true,
                'info': true,
                'autoWidth': false
            })
            $('#data-table1').DataTable({
                'paging': true,
                'lengthChange': true,
                'searching': true,
                'ordering': true,
                'info': true,
                'autoWidth': false
            })
            $('#data-table2').DataTable({
                'paging': true,
                'lengthChange': true,
                'searching': true,
                'ordering': true,
                'info': true,
                'autoWidth': false
            })
        });
    </script>

    <script>
        $(function () {
            $('input').iCheck({
                checkboxClass: 'icheckbox_square-blue',
                radioClass: 'iradio_square-blue',
                increaseArea: '20%' /* optional */
            });
        });
        function icheck() {
            $('input').iCheck({
                checkboxClass: 'icheckbox_square-blue',
                radioClass: 'iradio_square-blue',
                increaseArea: '20%' /* optional */
            });
        };
    </script>


    <script>

        //function populateProcess() {
        //    var elem = document.getElementById('select-process');
        //    var Code = elem.options[elem.selectedIndex].value;
        //    //console.log(elem);
        //    $.post('PopulateProcess', { ProcessCode: Code }).done(function (data) {
        //        if (data) {

        //        }
        //    });
        //};

        function getProggress() {
            var Code = $('#select-process').val();
            $.post('GetProgress', { ProcessCode: Code }).done(result => {
                if (result.ProcessList != null) {
                    //$('.appendremove').remove()
                    for (var x in result.ProcessList) {
                        var elem = $('#' + result.ProcessList[x].MapCode + '-' + result.ProcessList[x].Module + '-progressbar');
                        var sapdata = elem.attr("data-sap");
                        var progress = ((result.ProcessList[x].AddonData / sapdata) * 100).toFixed(2);
                        if (progress == 0.00) {
                            progress = 0;
                        }
                        var barlength = +progress;
                        if (barlength < 10)
                            barlength = 10;
                        elem.text(progress + '%');
                        elem.css("width", barlength + "%");
                    }
                    //icheck();
                    window.setTimeout(getProggress, 5000);
                }
                else {
                    swal('Unable to connect to database.', 'Please contact Administrator to resolve the issue', 'warning')
                }
            });
        }

        $(document).ready(function () {

            $.fn.populateSAPtoSAPProcess = function () {
                $('#preloader-modal').modal('show');
                var Code = $('#select-process').val();
                $.post('PopulateSAPtoSAPProcess', { ProcessCode: Code }).done(result => {
                    if (result.ProcessList != null) {
                        $('#process-table').dataTable().fnDestroy();
                        $('.appendremove').remove()

                        for (var x in result.ProcessList) {
                            //var barlength = +result.ProcessList[x].Progress;
                            //if (barlength < 10)
                            //    barlength = 10;
                            //var progress = (result.ProcessList[x].Progress).toFixed(2);
                            //if (progress == 0.00) {
                            //    progress = 0;
                            //}
                            var barlength = 1;
                            var progress = 1;
                            $('#process-table tbody').append('<tr class="appendremove">' +
                                '<td class="draftkey"><input type="checkbox" class="check" data-value="' + result.ProcessList[x].MapCode + '"></td>' +
                                '<td>' + result.ProcessList[x].MapCode + '</td>' +
                                '<td>' + result.ProcessList[x].MapName + '</td>' +
                                '<td>' + result.ProcessList[x].Module + '</td>' +
                                '<td><div id="' + result.ProcessList[x].MapCode + '-' + result.ProcessList[x].Module + '-progressbar" class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar" style="width: ' + barlength + '%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">' + progress + '%</div></td>' +
                                '</tr > ');
                        }
                        icheck();
                        $('#process-table').dataTable({ 'paging': false, });
                        $('#preloader-modal').modal('hide');
                    }
                    else {
                        $('#preloader-modal').modal('hide');
                        swal('Unable to connect to database.', 'Please contact Administrator to resolve the issue', 'warning')
                    }
                });
            }

            $.fn.populateProcess = function () {
                $('#preloader-modal').modal('show');
                var Code = $('#select-process').val();
                $.post('PopulateProcess', { ProcessCode: Code }).done(result => {
                    if (result.ProcessList != null) {
                        $('#process-table').dataTable().fnDestroy();
                        $('.appendremove').remove()

                        for (var x in result.ProcessList) {
                            var barlength = +result.ProcessList[x].Progress;
                            if (barlength < 10)
                                barlength = 10;
                            var progress = (result.ProcessList[x].Progress).toFixed(2);
                            if (progress == 0.00) {
                                progress = 0;
                            }
                            $('#process-table tbody').append('<tr class="appendremove">' +
                                '<td class="draftkey"><input type="checkbox" class="check" data-value="' + result.ProcessList[x].MapCode + '"></td>' +
                                '<td>' + result.ProcessList[x].MapCode + '</td>' +
                                '<td>' + result.ProcessList[x].MapName + '</td>' +
                                '<td>' + result.ProcessList[x].Module + '</td>' +
                                '<td><div id="' + result.ProcessList[x].MapCode + '-' + result.ProcessList[x].Module + '-progressbar" class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar" data-sap="' + result.ProcessList[x].SAPData + '" style="width: ' + barlength + '%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">' + progress + '%</div></td>' +
                                '</tr > ');
                        }
                        icheck();
                        $('#process-table').dataTable({ 'paging': false, });
                        $('#preloader-modal').modal('hide');
                    }
                    else {
                        $('#preloader-modal').modal('hide');
                        swal('Unable to connect to database.', 'Please contact Administrator to resolve the issue', 'warning')
                    }
                });
            }

            var activedata = new Array();
            var inactivedata = new Array();
            $('.select2').select2();
            //console.log($('#select-process').val());

            //$.fn.populateProcess();
            //window.setTimeout(getProggress, 5000);

            //$.post('/Upload/GetUploadDetails').done(result => { });

            //$.post('TryExecute', { MapCode: $('#select-server').val() }).done(function (data) {
            //    console.log(data);
            //    if (data) {
            //        if (!data.success) {
            //            //<p class="text-red">Text red to emphasize danger</p>
            //            //$("#execute-query").empty();
            //            //$('#execute-query').append('<p class="text-red">' + data.message + '</p>')
            //            //$('#execute-query-modal').modal('show');
            //            //swal('Something went wrong.', data.message, 'warning')

            //        }
            //        else {
            //            //$("#execute-query").empty();

            //            dataSet = data.JSONresult;
            //            var jsonobj = jQuery.parseJSON(dataSet);
            //            console.log(jsonobj[0])
            //            var my_columns = [];

            //            if (jsonobj == null || jsonobj == 0) {
            //                jsonobj = null;
            //                //$('#uploadbtn').prop('disabled', true);
            //            }
            //            else {
            //                //console.log(dataSet[0])
            //                $.each(jsonobj[0], function (key, value) {
            //                    var my_item = {};
            //                    console.log(my_item);
            //                    my_item.data = key;
            //                    my_item.title = key;
            //                    my_columns.push(my_item);
            //                });
            //            }

            //            $('#executeQueryTable').on('init.dt', function () {
            //                $('#dismissBtn')
            //                    .attr('data-dismiss', 'modal');
            //            });


            //            $('#executeQueryTable').DataTable({
            //                'destroy': true,
            //                'paging': true,
            //                'lengthChange': true,
            //                'searching': true,
            //                'ordering': true,
            //                'info': true,
            //                'autoWidth': false,
            //                data: jsonobj,
            //                "columns": my_columns,
            //                "scrollCollapse": true,
            //                "scrollX": true,
            //            })



            //            $('#execute-query-modal').modal('show');

            //        }

            //    }
            //});

            $(document)
                .on('change', '#docChk', function (e) {
                    //console.log('elkel');
                })
                .on('submit', '#upload-submit', function (e) {
                    e.preventDefault();

                })
                .on('change', '#field-map', function (e) {
                    var MapCode = $(this).val();
                    var deposit = "";
                    var statusclass = "label-danger";
                    var status = "Error";
                    $("#data-table tbody tr").remove();
                    $.post('GetDetails', { MapCode: MapCode }).done(result => {
                        for (var x in result.UploadList) {
                            if ($("#exist").length) {
                                deposit = '<td><button type="button" class="btn-primary btn-flat" data-toggle="modal" data-target="#deposit-modal" data-deposit-id="' + result.UploadList[x].TransactionId + '">Deposit</button></td>';
                                console.log(deposit);
                            }
                            if (result.UploadList[x].Status == 'O') {
                                statusclass = "label-success";
                                status = "Open";
                            }
                            else {
                                statusclass = "label-danger";
                                status = "Error";
                            }
                            $('#data-table tbody').append(
                                '<tr>' +
                                '<td width="5%"><input type="checkbox" class="icheckbox_square-blue flat-red check" data-upload-id="' + result.UploadList[x].TransactionId + '" /></td>' +
                                deposit +
                                '<td>' + result.UploadList[x].BranchCode + '</td>' +
                                '<td>' + result.UploadList[x].TranDate + '</td>' +
                                '<td>' + result.UploadList[x].CashierName + '</td>' +
                                '<td><span class="label ' + statusclass + '">' + status + '</span></td>' +
                                '<td>' + result.UploadList[x].Message + '</td>' +
                                '</tr>'
                            );

                        }
                        icheck();
                    })
                })
                .on('ifChecked', '#checkall', function (e) {
                    console.log($(this).val());
                    var table = $('#process-table').dataTable();
                    var allpages = table.fnGetNodes();
                    console.log(allpages);
                    $('td input[type="checkbox"]', allpages).iCheck('check');
                    $('td input[type="checkbox"]', allpages).val('checked');
                    $('td input[type="checkbox"]', allpages).each(function () {
                        inactivedata = [];
                        activedata.push($(this).data('upload-id'));
                    });
                    console.log(inactivedata);
                    console.log(activedata);


                })
                .on('ifUnchecked', '#checkall', function (e) {
                    console.log($(this).val());
                    var table = $('#process-table').dataTable();
                    var allpages = table.fnGetNodes();
                    $('td input[type="checkbox"]', allpages).iCheck('uncheck');
                    $('td input[type="checkbox"]', allpages).val('unchecked');
                    $('td input[type="checkbox"]', allpages).each(function () {
                        activedata = [];
                        inactivedata.push($(this).data('upload-id'));
                    });
                    console.log(activedata);
                    console.log(inactivedata);
                })
                .on('ifChecked', '.check', function (e) {
                    console.log($(this).val());
                    var check = $(this).data('upload-id');
                    inactivedata = $.grep(inactivedata, function (value) {
                        return value != check;
                    });
                    $(this).iCheck('check');
                    $(this).val('checked');
                    activedata.push(check);
                    console.log(activedata);
                    console.log(inactivedata);
                })
                .on('ifUnchecked', '.check', function (e) {
                    console.log($(this).val());
                    var check = $(this).data('upload-id');
                    activedata = $.grep(activedata, function (value) {
                        return value != check;
                    });
                    $(this).iCheck('uncheck');
                    $(this).val('unchecked');
                    inactivedata.push(check);
                    console.log(activedata);
                    console.log(inactivedata);
                });

            $(document).on('select2:select', '#select-server', function (e) {
                var Code = $(this).val();
                $.post('TryExecute', { MapCode: Code }).done(function (data) {
                    if (data) {
                        if (!data.success) {
                            //<p class="text-red">Text red to emphasize danger</p>
                            //$("#execute-query").empty();
                            //$('#execute-query').append('<p class="text-red">' + data.message + '</p>')
                            //$('#execute-query-modal').modal('show');
                            //swal('Something went wrong.', data.message, 'warning')

                        }
                        else {
                            //$("#execute-query").empty();

                            dataSet = data.JSONresult;
                            var jsonobj = jQuery.parseJSON(dataSet);
                            console.log(jsonobj[0]);
                            var my_columns = [];

                            if (jsonobj == null || jsonobj == 0) {
                                jsonobj = null;
                                //$('#uploadbtn').prop('disabled', true);
                                //Not applicable to disable, must consider the other Task.
                            }

                            //console.log(dataSet[0])
                            $.each(jsonobj[0], function (key, value) {
                                var my_item = {};
                                console.log(my_item);
                                my_item.data = key;
                                my_item.title = key;
                                my_columns.push(my_item);

                            });

                            $('#executeQueryTable').on('init.dt', function () {
                                $('#dismissBtn')
                                    .attr('data-dismiss', 'modal');
                            });
                            $('#executeQueryTable').DataTable({
                                'destroy': true,
                                'paging': true,
                                'lengthChange': true,
                                'searching': true,
                                'ordering': true,
                                'info': true,
                                'autoWidth': true,
                                data: jsonobj,
                                "columns": my_columns,
                                "scrollCollapse": true,
                                "scrollX": true,

                            })
                            $('#execute-query-modal').modal('show');

                        }

                    }
                });
            });
            $(document).on('select2:select', '#select-process', function (e) {
                //$.fn.populateProcess(); DB to DB
                $.fn.populateSAPtoSAPProcess(); //SAP to SAP
            });
        }).
            on('click', '#uploadbtn', function () {
                var Code = $('#select-server').val();

                //$.post('Upload', { MapCode: Code }).done(function (data) {
                //    if (data) {
                //        swal("Uploaded Successfully");
                //    }
                //    else {

                //        swal('Something went wrong.', data.message, 'warning')
                //    }
                //});
                var codes = [];
                var progress = [];
                $('input[type=checkbox].check').each(function () {
                    if (this.checked) {
                        progress.push($(this).parent().parent().parent().find('div.progress-bar'));
                        codes.push($(this).data('value'));
                    }
                    //sList += "(" + $(this).val() + "-" + (this.checked ? "checked" : "not checked") + ")";
                });
                swal({
                    title: 'Are you sure you want to Upload?',
                    text: "You want to post this data?",
                    type: 'info',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes'
                }).then((result) => {
                    if (result.value) {
                        //$.post('Upload', {
                        //    MapCode: Code
                        //}).done(function (data) {
                        //    if (data) {
                        //        swal('Success!', '', 'success')
                        //        setTimeout(function () { window.location.href = ""; }, 1500);
                        //    }
                        //}).fail(function () {
                        //    swal('Something went wrong.', 'Please contact the administrator.', 'warning')
                        //});
                        progress.forEach(function (item, index) {
                            item.addClass("active");
                        });
                        $('#uploadbtn').attr('disabled', 'disabled');
                        //$.post('Upload', { DB to DB
                        $.post('UploadSAPtoSAP', { //SAP to SAP
                            MapCode: codes
                        }).done(function (data) {
                            if (data) {
                                swal('Success!', '', 'success')
                                progress.forEach(function (item, index) {
                                    item.removeClass("active");
                                });
                                $('#uploadbtn').removeAttr('disabled');
                                //setTimeout(function () { window.location.href = ""; }, 1500);
                            }
                        }).fail(function () {
                            progress.forEach(function (item, index) {
                                item.removeClass("active");
                            });
                            $('#uploadbtn').removeAttr('disabled');
                            swal('Something went wrong.', 'Please contact the administrator.', 'warning')
                        });
                    }
                })
            });


    </script>
}
