@model  DomainLayer.ViewModels.MapCreateViewModel

<section class="content">
    <div class="row">
        <div class="col-xs-12">
            <div class="box" style="background-color: transparent; border: unset;">
             
                    <button type="button" class="btn btn-primary" id="api-details-swagger" style="float: left, inline-start;">View API details</button>
         
            </div>
            <div class="box">
                <div class="box-header">
                    <h3 class="box-title">API Manager</h3>
                </div>
                <!-- /.box-header -->
                <div class="box-body">
                    <table id="feature" class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>Edit</th>
                                <th>Title</th>
                                <th>API Code</th>
                                <th>API Method</th>
                                <th>Query Code</th>
                                <th>SAP Setup Code</th>
                                <th>IsActive</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var manage in Model.APIManagerView)
                            {
                                <tr>
                                    <td width="5%"><button type="button" class="btn-info btn-flat fa fa-edit" data-toggle="modal" data-target="#edit-modal" data-apiid="@manage.Id"></button></td>
                                    <td>@manage.Title</td>
                                    <td>@manage.APICode</td>
                                    <td>@manage.Method</td>
                                    <td>@manage.QueryCode</td>
                                    <td>@manage.SAPCode</td>
                                    @if (manage.IsActive == true)
                                    {
                                        <td><span class="label label-success">Active</span></td>
                                    }
                                    else
                                    {
                                        <td><span class="label label-danger">In Active</span></td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table><button type="button" class="btn btn-primary btn-custom2" id="new-apisetup" style="float: right;" data-toggle="modal" data-target="#create-modal">New</button>
                </div><!-- /.box-body -->
            </div>
        </div>
    </div>
</section>

<div class="modal fade" id="create-modal">
    <form id="apisetup-submit">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">API Generator</h4>
                </div>
                <div class="modal-body">
                    <div class="register-box-body">
                        <div class="form-group" id="createAPIQueryCode">
                            <label>*Title:</label>
                            <div class="input-group">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-cog"></i></span>
                                <input type="text" id="api-title" class="form-control syncquery" placeholder="API Title" required>
                            </div>
                        </div>

                        <div class="form-group" id="createSyncCodeFormgroup">
                            <label>*API Code:</label>
                            <div class="input-group">
                                <div class="input-group-addon"><i class="glyphicon glyphicon-compressed"></i></div>
                                <select class="form-control select2" style="width: 100%;" id="selectAPI" placeholder="API Code">
                                    @foreach (var module in Model.APIView)
                                    {
                                        <option>@module.APICode</option>
                                    }
                                </select>
                            </div>
                        </div>

                        <div class="form-group" id="createSyncQueryCodeFormgroup">
                            <label>*Method:</label>
                            <div class="input-group">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-cog"></i></span>
                                <input type="text" id="api-method" class="form-control syncquery" placeholder="Method" disabled required>
                            </div>
                        </div>

                        <div class="form-group" id="createQueryCodeFormgroup">
                            <label id="api-type">*Query Code:</label>
                            <div class="input-group">
                                <div class="input-group-addon"><i class="glyphicon glyphicon-align-left"></i></div>
                                <select class="form-control select2" style="width: 100%;" id="selectQuery" placeholder="Query Code">
                                </select>
                            </div>
                        </div>

                        @*<div class="form-group" id="createSyncQueryCodeFormgroup">
                                <label>*Query Name:</label>
                                <div class="input-group">
                                    <span class="input-group-addon"><i class="glyphicon glyphicon-cog"></i></span>
                                    <input type="text" id="createAPIQueryCode" value="@Model." class="form-control syncquery" placeholder="Query Name" required>
                                </div>
                            </div>*@

                        <div class="row">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default btn-custom" data-dismiss="modal">Close</button>
                    <button type="submit" id="apisetup-submit" class="btn btn-primary btn-custom">Save</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </form>
</div>

<div class="modal fade" id="edit-modal">
    <form id="update-apisetup-submit">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">Sync Query Setup</h4>
                </div>
                <div class="modal-body">
                    <div class="register-box-body">

                        <div class="form-group" id="createAPIQueryCode">
                            <label>*Title:</label>
                            <div class="input-group">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-cog"></i></span>
                                <input type="text" id="edit-api-title" class="form-control syncquery" placeholder="API Title" required>
                            </div>
                        </div>

                        <div class="form-group" id="createSyncCodeFormgroup">
                            <label>*API Code:</label>
                            <div class="input-group">
                                <div class="input-group-addon"><i class="glyphicon glyphicon-compressed"></i></div>
                                <select class="form-control select2" style="width: 100%;" id="edit-selectAPI" placeholder="API Code">
                                    @foreach (var module in Model.APIView)
                                    {
                                        <option>@module.APICode</option>
                                    }
                                </select>
                            </div>
                        </div>

                        <div class="form-group" id="createSyncQueryCodeFormgroup">
                            <label>*Method:</label>
                            <div class="input-group">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-cog"></i></span>
                                <input type="text" id="edit-api-method" class="form-control syncquery" placeholder="Method" required disabled>
                            </div>
                        </div>

                        <div class="form-group" id="createQueryCodeFormgroup">
                            <label id="edit-api-type"></label>
                            <div class="input-group">
                                <div class="input-group-addon"><i class="glyphicon glyphicon-align-left"></i></div>
                                <select class="form-control select2" style="width: 100%;" id="edit-selectQuery">
                                </select>
                            </div>
                        </div>

                        <div class="row">
                        </div>

                        <div class="form-group" id="featurecode-formgroup">
                            <label></label>
                            <div class="input-group">
                                <input type="checkbox" class="flat-red" id="edit-api-active" /> Is Active?
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default btn-custom" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary btn-custom">Save</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </form>
</div>
@section Scripts {
    <script>
        $(function () {
            $('input').iCheck({
                checkboxClass: 'icheckbox_square-blue',
                radioClass: 'iradio_square-blue',
                increaseArea: '20%' /* optional */
            });
        });

        $(function () {
            $('.select2').select2()
        });
        $('[data-mask]').inputmask();
    </script>
    <script>

        $(document).on('submit', '#apisetup-submit', function (e) {
            e.preventDefault();

            var apiCode = $("#selectAPI").val();
            var queryCode = $("#selectQuery").val();
            var method = $("#api-method").val();
            var title = $("#api-title").val();
            console.log(title);
            swal({
                title: 'Are you sure you want to save new API settings?',
                text: "",
                type: 'info',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes'
            }).then((result) => {
                if (result.value) {

                    $.post('CreateAPISetup', {
                        QueryCode: queryCode,
                        SAPCode: queryCode,
                        Method: method,
                        APICode: apiCode,
                        Title: title,
                    }).done(function (data) {
                        if (data) {
                            $("#feature").load("Process #feature");
                            $('.modal').modal('hide');
                            setTimeout(function () { window.location.href = ""; }, 1500);
                        }
                    }).fail(function () {
                        swal('Something went wrong.', 'Please contact the administrator.', 'warning')
                    });
                }
            })
        }).on('click', 'button[data-apiid]', function () {
            var id = $(this).data('apiid');
            ids = id;
            $.post('FindAPIManager', { Id: id }).done(result => {
                var i = 0;
                for (var x in result.APIManagerList) {


                    var process = result.APIManagerList[x].QueryCode;
                    //console.log(process);
                    var arr = process.split(",");
                    //console.log(arr);

                    $("#edit-api-title").val(result.APIManagerList[x].Title);
                    $("#edit-selectAPI").val(result.APIManagerList[x].APICode);
                    $('#edit-selectAPI').trigger('change');
                    $("#edit-api-method").val(result.APIManagerList[x].Method);


                    //$("#edit-selectQuery").val(arr);
                    //$('#edit-selectQuery').trigger('change');
                    //console.log(result.APIManagerList[x].QueryCode);
                    $('.select_100 option[value=MasterData1]').attr('selected', 'selected');

                    if (result.APIManagerList[x].APIMethod == "POST") {
                        $("#edit-api-type").text("*SAP Code");
                    }
                    else {
                        $("#edit-api-type").text("*Query Code");
                    }

                    if (result.APIManagerList[x].IsActive == true) {
                        $('input:checkbox[id = edit-api-active]').iCheck('check');
                        $('input:checkbox[id = edit-api-active]').val('checked');
                    }
                    else {
                        $('input:checkbox[id = edit-api-active]').iCheck('uncheck');
                        $('input:checkbox[id = edit-api-active]').val('unchecked');
                    }

                    $('input:checkbox[id = edit-api-active]').on('ifChecked', function (event) {
                        $('input:checkbox[id = edit-api-active]').val('checked');
                    });

                    $('input:checkbox[id = edit-api-active]').on('ifUnchecked', function (event) {
                        $('input:checkbox[id = edit-api-active]').val('unchecked');
                    });
                }
            })
        }).on('submit', '#update-apisetup-submit', function (e) {
            e.preventDefault();
            var id = ids;
            var IsActive;
            var ChkboxVal = $('#edit-api-active').val();
            console.log(ChkboxVal);
            if (ChkboxVal == 'checked') { IsActive = true; }
            else { IsActive = false; }

            var apiCode = $("#edit-selectAPI").val();
            var method = $("#edit-api-method").val();
            var queryCode = $("#edit-selectQuery").val();
            var title = $("#edit-api-title").val();

            swal({
                title: 'Are you sure?',
                text: "You want to update the following data?",
                type: 'info',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes'
            }).then((result) => {
                if (result.value) {
                    $.getJSON('UpdateAPISetup', {
                        Id: id,
                        QueryCode: queryCode,
                        SAPCode: queryCode,
                        APICode: apiCode,
                        Title: title,
                        Method: method,
                        IsActive: IsActive
                    }).done(function (data) {
                        if (data) {
                            swal('Success!', '', 'success')
                            //$("#feature").load("Process #feature");
                            $('.modal').modal('hide');
                            setTimeout(function () { window.location.href = ""; }, 1500);
                        }
                    }).fail(function () {
                        swal('Something went wrong.', 'Please contact the administrator.', 'warning')
                    });
                }
            })
        });

        $("#selectAPI").change(function () {
            var code = $("#selectAPI").val();
            $("#selectQuery").empty();
            $.post('GetAPIMethod', {
                Code: code
            }).done(result => {

                $("#api-method").val(result.APIDetails.APIMethod);

                if (result.APIDetails.APIMethod == "POST") {

                    $("#api-type").text("*SAP Code");

                    $.getJSON('GetSAPSetup', function (result) {

                        console.log(result);
                        for (var x in result) {
                            $("#selectQuery").append($('<option>', {
                                value: result[x].SAPCode,
                                text: result[x].SAPCode
                            }));
                        }
                    });

                }
                else {

                    $("#api-type").text("*Query Code");

                    $.get('GetQuerySetup', function (result) {

                        for (var x in result.QueryManagerView) {
                            $("#selectQuery").append($('<option>', {
                                value: result.QueryManagerView[x].QueryCode,
                                text: result.QueryManagerView[x].QueryCode
                            }));
                        }
                    });

                }
            })
        });

        $("#edit-selectAPI").change(function () {
            var code = $("#edit-selectAPI").val();
            $("#edit-selectQuery").empty();
            $.post('GetAPIMethod', {
                Code: code
            }).done(result => {

                $("#edit-api-method").val(result.APIDetails.APIMethod);

                if (result.APIDetails.APIMethod == "POST") {

                    $("#edit-api-type").text("*SAP Code");

                    $.getJSON('GetSAPSetup', function (result) {

                        console.log(result);
                        for (var x in result) {
                            $("#edit-selectQuery").append($('<option>', {
                                value: result[x].SAPCode,
                                text: result[x].SAPCode
                            }));
                        }
                    });

                }
                else {

                    $("#edit-api-type").text("*Query Code");

                    $.get('GetQuerySetup', function (result) {

                        for (var x in result.QueryManagerView) {
                            $("#edit-selectQuery").append($('<option>', {
                                value: result.QueryManagerView[x].QueryCode,
                                text: result.QueryManagerView[x].QueryCode,
                            }));
                            console.log(result.QueryManagerView[x].QueryCode);
                            console.log(result.QueryManagerView[x].QueryCode);
                        }
                    });

                }

            })
        });

        $("#api-details-swagger").on('click', function () {
            //alert("clicked by client");
            window.open("http://localhost:40710/swagger/ui/index")
        });
    </script>
}
